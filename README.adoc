= üóÇÔ∏è `vzd-cli`: Command Line Client f√ºr Verzeichnisdienst der TI 
:toc: auto
:note-caption: Anmerkungen

image::images/vzd-cli.gif[]

`vzd-cli` 2.0 wurde in Vorbereitung der Migration des gematik Verzeichnisdienstes (VZD) von LDAP nach FHIR entwickelt. √úber ein modernes CLI (Command Line Interface) k√∂nnen neue und alte Schnittstellen des VZD genutzt werden.

`vzd-cli` enth√§lt ein link:COMPATIBILITY_MODE.adoc[Kompatibilit√§tsmodus zur VZDClient 1.6] um bereits vorhandene Konfigurationen und Skripte nachnutzen zu k√∂nnen. 

== Installation

Die link:https://github.com/spilikin/app-vzd-cli/releases[neueste Version] von `vzd-cli` herunterladen.

F√ºr die Ausf√ºhrung des `vzd-cli` soll die `PATH` Variable um den Pfad `vzd-cli-<VERSION>/bin` erweitert werden.

Sobald der Befehl `vzd-cli` ausgef√ºhrt werden kann sind wir start klar:
[source]
----
$ vzd-cli

Usage: vzd-cli [OPTIONS] COMMAND [ARGS]...

Options:
  -v          Display log, use -vv for even more details
  --version   Show the version and exit
  -h, --help  Show this message and exit

Commands:
  config               Manage configuration
  update               Updates this software
  admin                CLI for DirectoryAdministration API
  apo                  CLI for ApoVZD API
  gui                  Starts HTTP Server with GUI
  pers                 Process gematik SMC-B/HBA Exports
  generate-completion  Generate a tab-complete script for the given shell
----


== Erste Schritte

Aufbau des `vzd-cli` folgt aktuellen Best-Practices analog z.B. zu Docker.
F√ºr alle Befehle (Commands) und Unter-Befehle (Subcommands) kann man mittels `--help` Option eine abschlie√üende Liste aller Optionen und Argumente anzeigen lassen.

[source,bash]
----
vzd-cli --help
vzd-cli config --help
vzd-cli config get --help
vzd-cli admin --help
vzd-cli admin ru --help
----

== Konfiguration

Die Directory APIs werden √ºber HTTPS erreicht. Falls f√ºr die Verbindung ein HTTP-Proxy erforderlich ist, muss es wie folgt konfiguriert werden:

[source,bash]
----
# Beispiel Proxy (http://PROXY_HOST:PROXY_PORT)
vzd-cli config set httpProxy.proxyURL http://192.168.0.1:8080
vzd-cli config set httpProxy.enabled true
----

`vzd-cli` erm√∂glicht u.a. die Nutzung folgender APIs:

* Directory Admin API
* Apo API (ApoVZD)

F√ºr die Nutzung dieser APIs sind jeweils entsprechende Geheimnisse bzw. Credentials erforderlich.
Diese werden von der gematik *den bereichtigten Organistionen* bereitgestellt.

=== Admin API Credentials

Directory Admin API benutzt f√ºr die Authentisierung das Oauth2 Client Credentials Flow.
Um hierf√ºr erforderlichen Credentials angemessen sicher aufbewahren zu k√∂nnen, stellt `vzd-cli` eine Vault (Tresor) Funktion bereit.
Mithilfe der Vault werden alle Client IDs und Client Secrets verschl√ºsselt gespeichert.
Um Vault aufmachen und darin enthaltenen Credentials nutzen zu k√∂nnen, wird der Nutzer aufgefordert einen Vault-Password zu vergeben.
Dieser Password funktioniert analog zu den privaten Passw√∂rtern bei den Password-Managern (z.B. Bitwarden, LastPass, 1Password).
Die Vault Implementierung befinden sich in der Datei `Vault.kt` und verwendet von NIST emfohlene Verschl√ºsselung.

Falls das Speichern der Credentials nicht erw√ºnscht ist, kann die Anmeldung direkt mit Client ID und Client Secret erfolgen, s. `vzd-cli admin login-cred`.

[source,bash]
----
# Vault zur√ºcksetzen
vzd-cli admin vault purge

# Secret f√ºr die Referenzumgebung speichern
# es folgt eine Vault Passwortabfrage
vzd-cli admin vault store -e ru -c <CLIEND_ID> -s <CLIENT_SECRET>

# Secret f√ºr die Produktivumgebung speichern
# es folgt eine Vault Passwortabfrage
vzd-cli admin vault store -e pu -c <CLIEND_ID> -s <CLIENT_SECRET>
----

Vault Password kann alternativ √ºber die Umgebungsvariable `VAULT_PASSWORD` (empfohlen) oder √ºber `--password` Parameter angegeben werden (nicht empfohlen).

=== Apo API API-Keys

Zugriff auf Apo API (ApoVZD) wird mittels API-KEYs gesch√ºtzt.
Die API-KEYs werden durch die gematik an *die berechtigte Anwendungen* vergeben.

[source,bash]
----
# API Key f√ºr die Testinstanz
vzd-cli apo config set apiKeys.test <API_KEY_TEST>
# API Key f√ºr die Produktivinstanz
vzd-cli apo config set apiKeys.prod <API_KEY_PROD>
----

== Erste Schritte

Befor die Directory Admin API genutzt werden kann, muss eine Anmeldung erfolgen.
Die Anmeldung muss alle 6 Stunden wiederholt werden.

[source,bash]
----
# Anmelden in die Referenzumgebung (ru)
# es folgt eine Vault-Passwortabfrage
vzd.cli admin ru login
# Anmelden in die Referenzumgebung (pu)
# es folgt eine Vault-Passwortabfrage
vzd.cli admin pu login
----

F√ºr vollautomatisierte Nutzung des `vzd-cli`, auch bei der Anmeldung, wird das setzten der Umgebungsvariable `VAULT_PASSWORD` empfohlen.
Dabei soll die Umgebungsvarianle den w√§hrend der Konfiguration angegeben Vault Passwort enthalten.

.*Beispiel:* Suche nach allen Eintragen mit _M√ºller_ im Namen in der Referenzumgebung (`ru`)
[source,bash]
----
vzd-cli admin ru search M√ºller
----

.*Beispiel:* Suche nach den Eintr√§gen in Berlin in der Produktivumgebung (`pu`)
[source,bash]
----
vzd-cli admin pu search Berlin
----

.*Beispiel:* Suche nach allen Eintragen in _Berlin_ mit dem Namen _M√ºller_ in der Referenzumgebung (`ru`)
[source,bash]
----
vzd-cli admin ru search M√ºller Berlin
----


.*Beispiel:* Anzeige der Detailinformationen f√ºr die angegebene telematikID in der Referenzumgebung (`ru`)
[source,bash]
----
vzd-cli admin ru show 1-SMC-B-Testkarte-883110000117729
----

== √úbergreifende Befehle

=== `vzd-cli config`

Befehle f√ºr Konfiguration des `vzd-cli`. Folgende Konfigurationsparameter k√∂nnen ge√§ndert werden (s. `vzd-cli config set --help`)

* `httpProxy.enabled` - wenn `true`, wird Proxy-Server bei allen Anfragen genutzt. Wenn `false` werden HTTP-Requests direkt ohne Proxy durchgef√ºhrt
* `httpProxy.proxyURL`: URL des HTTP-Proxy Servers ggf. mit Port, z.B.: `http://192.168.0.1:8080`
* `updates.preReleasesEnabled`: wenn `true`, werden beim `vzd-cli update` die Pre-Releses installiert

.*Beispiel:* Aktuelle Konfiguration anzeigen
[source,bash]
----
vzd-cli config get
----


.*Beispiel:* Konfigurationsparameter √§ndern
[source,bash]
----
vzd-cli config set httpProxy.proxyURL "http://example.com:8080"
vzd-cli config set httpProxy.enabled true
vzd-cli config set updates.preReleasesEnabled true
----

.*Beispiel:* Konfiguration zur√ºcksetzen
[source,bash]
----
vzd-cli admin config reset
----


=== `vzd-cli update`

Aktualisiert das `vzd-cli` auf die neusete (oder angegebene Version).
Anmerkung: Self-Updates werden erst ab der Version 2.1 unterst√ºtzt.

.*Beispiel:* Falls eine neuere Version verf√ºgbar ist, wird diese von github.com heruntergeladen und installiert
----
vzd-cli update
----

.*Beispiel:* Installiert eine bestimmte Version (auch Downgrade ist m√∂glich):
----
vzd-cli update 2.1.0-beta4
----

== `vzd-cli admin`: Directory Administration

=== `admin vault`

Befehle zur Verwaltung von OAuth2 Geheimnissen

----
Usage: vzd-cli admin vault [OPTIONS] COMMAND [ARGS]...

  Manage OAuth credentials in the Vault

Options:
  -h, --help  Show this message and exit

Commands:
  purge   Remove Vault
  list    List configured OAuth2 credentials
  store   Store OAuth2 client credentials
  export  Export Vault to a file for backup or transfer.
  import  Import credentials from another Vault
----

=== `admin status`

Zeigt die Information √ºber den aktuellen Zustand des Clients.
Insb. wird angezeigt in welche Umgebungen man angemeldet ist, OAuth2 Token Informationen und die Informationen √ºber Backend APIs.

[source,bash]
----
vzd-cli admin status
----

=== `admin <tu|ru|pu> login`

Anmelden beim OAuth2 Server mit Client-Credentials aus dem Vault.

.*Beispiel:* In alle drei Umgebungen einloggen (vorausgesetzt alle drei ClientIDs sind √ºber `vzd-cli admin vault` hinterlegt)
[source,bash]
----
vzd-cli admin tu login
vzd-cli admin ru login
vzd-cli admin pu login
----

NOTE: Im Gegensatz zu Vault und darin enthaltenen Client-Credentials, werden die zeitlich befristete `ACCESS_TOKEN` unverschl√ºsselt im Ordner `$HOME/.telematik/` gespeichert.
Die Tokens sind 6 Stunden g√ºltig.

=== `admin <tu|ru|pu> login-cred`

Anmelden beim OAuth2 Server mit explizit angegeben Client-Credentials

.*Beispiel:* Client-Id und Client-Secret werden √ºber Parameter √ºbergeben, Referenzumgebung (`ru`)
[source,bash]
----
vzd-cli admin ru login-cred -c myclient -s mysecret
----

.*Beispiel:* Client-Id wird √ºber Parameter √ºbergeben, Client-Secret wird aus der Umgebungsvariable `CLIENT_SECRET` ausgelesen, Referenzumgebung (`ru`)
[source,bash]
----
export CLIENT_SECRET=mysecret
vzd-cli admin ru login-cred -c myclient
----


=== `admin <tu|ru|pu> token`

Zeigt den aktuellen `ACCESS_TOKEN` zur√ºck. Token kann danach in der Umgebungsvariable `ADMIN_ACCESS_TOKEN` gespeichert werden, damit weitere Client-Aufrufe keine erneute explizite Authentisierung durchf√ºhren m√ºssen.

.*Beispiel:* Speichert den ACCESS_TOKEN in die Umgebungsvariable und f√ºhrt anschlie√üend eine Query mit curl.
[source,bash]
----
vzd-cli admin ru login
export ADMIN_ACCESS_TOKEN=$(vzd-cli admin ru token)
curl -H "Accept: application/json" \
  -H "Authorization: Bearer $ADMIN_ACCESS_TOKEN" \
  https://vzdpflege-ref.vzd.ti-dienste.de:9543/DirectoryEntries?baseEntryOnly=true
----

=== `admin <tu|ru|pu> search`

F√ºhrt eine benutzerfreundliche Suche nach Eintr√§gen. Dabei werden Natural Language Processing Algorithmen verwenden um angegebene Suchkriterien zu ermitteln.
Derzeit werden folgende Kriterien unterst√ºtzt:

* Orte in Deutschland, z.B. _Berlin_, _Bad Homburg_, _Frankfurt am Main_
* Deutsche Postleitzahlen
* TelematikIDs
* Betriebsst√§tten / IK-Nummer

.*Beispiele:*
[source,bash]
----
# Name und Ort
vzd-cli admin ru search M√ºller Berlin
# Ort und l√§ngerer Name
vzd-cli admin ru search Berlin Praxis M√ºller
# nur Name
vzd-cli admin ru search Praxis M√ºller
# Name und PLZ
vzd-cli admin ru search Praxis M√ºller 45144
# Erste Nummern der TelematikID (Nidergelassene Arztpraxen)
vzd-cli admin ru search 1-20

=== `admin list`

==== Optionen
* `--param` oder `-p` +
Setzt einen Query-Parameter bei der Suche der Eintr√§ge √ºber die API. Kann mehrfach angegeben werden um die Parameter zu kombinieren. +
Die Liste von g√ºltigen Parametern kann aus https://github.com/gematik/api-vzd/blob/master/src/openapi/DirectoryAdministration.yaml[DirectoryAdministration API] entnommen werden (s. `read_Directory_Entry`)

* `--param-file` oder `-f` +
Liest Werte eines Parameters aus der Datei und fragt f√ºr jeden Wert nach Eintrag im VZD ab. Die Datei soll den gew√ºnschten Wert einmal pro Zeile enthalten:

.Beispiel: Findet alle Eintr√§ge mit TelematikID aus `telematik.txt`
[source,bash]
----
vzd-cli admin --short list -f telematikID telematik.txt
----

.Inhalt von `telematik.txt`
----
4-SMC-B-Testkarte-883110000093329
3-SMC-B-Testkarte-883110000093294
2-SMC-B-Testkarte-883110000093645
3-SMCB-Testkarte-883110000092193
----


Suche und Anzeige von Verzeichnisdiensteintr√§gen.

[#cmd-admin-template]
=== `admin template`

Generiert die Dateivorlagen f√ºr `admin add` oder `admin modify` Befehle.

.Beispiel: Erzeugt eine Vorlage und schreibt es in eine YAML-Datei 
[source,bash]
----
vzd-cli admin template base > Eintrag.yaml
----

.Beispiel: Erzeugt eine Vorlage und schreibt es in eine JSON-Datei 
[source,bash]
----
vzd-cli admin --json template base > Eintrag.json
----

[#cmd-admin-add-base]
=== `admin add-base`

Neuen Verzeichnisdiensteintrag erstellen.

[#cmd-admin-load-base]
=== `admin load-base`

L√§dt einen Basiseintrag. Die geladene Struktur kann als Datei gespeichert werden, in einem Text-Editor bearbeitet und anschlie√üend mit `admin modify-base` modifiziert werden.

[#cmd-admin-modify-base]
=== `admin modify-base`

Modifiziert den gesamten Basiseintrag im Verzeichnisdienst.

[#cmd-admin-modify-base-attr]
=== `admin modify-base-attr`

Modifiziert einzelne Attribute des Basiseintrags

[#cmd-admin-delete]
=== `admin delete`

L√∂scht Eintr√§ge aus dem Verzeichnisdienst.

[#cmd-admin-list-cert]
=== `admin list-cert`

Suche und Anzeige von X509-Zertifikaten.

[#cmd-admin-add-cert]
=== `admin add-cert`

F√ºgt einen neuen X509-Zertifikat zu existierenden Verzeichnisdiensteintrag hinzu.

[source,bash]
----
# zuerst einen leeren Basiseintrag erzeugen
vzd-cli admin add-base -s telematikID=1-123123
# danach Zertifikat hinzuf√ºgen
# Achtung: TelematikID beim Befehl admin add-base und im Zertifikat m√ºssen identisch sein
vzd-cli admin add-cert 1-123123.der
----

[source,bash]
----
# F√ºgt alle Zertifikate aus dem aktuellen Ordner das VZD
# TelematikID und BasisEintrag werden automatisch aus dem Zertifikat 
# ermittelt (Admission Statement -> Registration Number)
vzd-cli admin add-cert *.der
----



[#cmd-admin-clear-cert]
=== `admin clear-cert`

L√∂scht alle Zertifikate aus dem angegeben Eintrag.

[source,bash]
----
vzd-cli admin clear-cert -p telematikID=1-123123
----

[#cmd-admin-save-cert]
=== `admin save-cert`

Speichert alle gefundene Zertifikate in ein Verzeichnis

[#cmd-admin-delete-cert]
=== `admin delete-cert`

WARNING: Nicht implementiert. Bitte `admin clear-cert` verwenden.

L√∂scht einen X509-Zertifikat.

[#cmd-admin-cmd]
=== `admin cmd`

Aktiviert link:COMPATIBILITY_MODE.adoc[Kompatibilit√§tsmodus zur VZDClient 1.6]

----
Usage: vzd-cli admin cmd [OPTIONS]

  Compatibility mode: support for VZDClient XML-commands

Options:
  -p, --params CONF_FILE       Configuration file containing the config
                               parameters
  -c, --cred CREDENTIALS_FILE  File containing the access credentials
                               (deprecated)
  -b, --batch COMMANDS_FILE    XML file containing the commands
  -h, --help                   Show this message and exit
----

[#cmd-dump-create]
=== `admin dump create`

L√§dt gro√üe Mengen von Eintr√§gen und schreibt sie in `STDOUT`, eine Zeile per Eintrag als JSON. So erzeugte Dumps k√∂nnen durch weitere Tools verarbeitet werden, z.B. https://gnupg.org[GnuPG] oder https://github.com/antonmedv/fx[FX].

[#cmd-dump-ocsp]
=== `admin dump ocsp`

Lie√üt die Eintr√§ga aus STDIN, stellt f√ºr jeden gefundenen Zertifikat eine OCSP-Abfrage.
